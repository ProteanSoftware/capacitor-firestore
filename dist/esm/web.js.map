{"version":3,"file":"web.js","sourceRoot":"","sources":["../../src/web.ts"],"names":[],"mappings":"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","sourcesContent":["import { WebPlugin } from '@capacitor/core';\r\nimport { initializeApp, deleteApp } from \"firebase/app\";\r\nimport type { FirebaseApp } from \"firebase/app\";\r\nimport { getAuth, signInWithCustomToken } from \"firebase/auth\";\r\nimport type { Firestore, Query, Unsubscribe } from \"firebase/firestore\";\r\nimport {\r\n  initializeFirestore,\r\n  terminate,\r\n  enableIndexedDbPersistence,\r\n  onSnapshot,\r\n  doc,\r\n  getDoc,\r\n  getDocs,\r\n  updateDoc,\r\n  setDoc,\r\n  deleteDoc,\r\n  addDoc,\r\n  collection,\r\n  query,\r\n  where,\r\n  CACHE_SIZE_UNLIMITED\r\n} from \"firebase/firestore\";\r\n\r\nimport type {\r\n  CallbackId,\r\n  CapacitorFirestorePlugin,\r\n  CollectionSnapshot,\r\n  CollectionSnapshotCallback,\r\n  CustomToken,\r\n  DocumentSnapshot,\r\n  DocumentSnapshotCallback,\r\n  DocumentReference,\r\n  FirestoreConfig,\r\n  RemoveSnapshotListener,\r\n  UpdateDocument,\r\n  SetDocument,\r\n  AddDocument,\r\n  DocumnentQuery,\r\n  CollectionQuery\r\n} from './definitions';\r\n\r\nexport class CapacitorFirestoreWeb extends WebPlugin implements CapacitorFirestorePlugin {\r\n  private app: FirebaseApp | null = null;\r\n  private firestore: Firestore | null = null;\r\n\r\n  private subscriptions: { [id: string]: Unsubscribe; } = {};\r\n\r\n  public initializeFirestore(options: FirestoreConfig): Promise<void> {\r\n    let teardownPromise = Promise.resolve();\r\n\r\n    if (this.firestore !== null) {\r\n      teardownPromise = terminate(this.firestore);\r\n    }\r\n\r\n    teardownPromise = teardownPromise.then(() => {\r\n      if (this.app !== null) {\r\n        deleteApp(this.app);\r\n      }\r\n    });\r\n\r\n    const initPromise = teardownPromise.then(() => {\r\n      const app = initializeApp({\r\n        apiKey: options.apiKey,\r\n        appId: options.applicationId,\r\n        projectId: options.projectId\r\n      }, \"CapacitorFirestore\");\r\n\r\n      this.app = app;\r\n\r\n      const firestore = initializeFirestore(app, {\r\n        cacheSizeBytes: CACHE_SIZE_UNLIMITED\r\n      });\r\n\r\n      return firestore;\r\n    });\r\n\r\n    return initPromise.then(firestore => {\r\n      enableIndexedDbPersistence(firestore).then(() => {\r\n        this.firestore = firestore;\r\n      });\r\n    });\r\n  }\r\n\r\n  public addDocumentSnapshotListener<T>(options: DocumnentQuery, callback: DocumentSnapshotCallback<T>): Promise<CallbackId> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    const unSubFunc = onSnapshot(doc(this.firestore, options.reference), snapshot => {\r\n      callback({\r\n        id: snapshot.id,\r\n        path: snapshot.ref.path,\r\n        data: snapshot.exists() ? snapshot.data() as T : null\r\n      });\r\n    });\r\n\r\n    const id = new Date().getTime().toString();\r\n    this.subscriptions[id] = unSubFunc;\r\n\r\n    return Promise.resolve(id);\r\n  }\r\n\r\n  public getDocument<T>(options: DocumnentQuery): Promise<DocumentSnapshot<T>> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    return getDoc(doc(this.firestore, options.reference)).then(snapshot => {\r\n      return {\r\n        id: snapshot.id,\r\n        path: snapshot.ref.path,\r\n        data: snapshot.exists() ? snapshot.data() as T : null\r\n      };\r\n    });\r\n  }\r\n\r\n  public updateDocument<T>(options: UpdateDocument<T>): Promise<void> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    return updateDoc(doc(this.firestore, options.reference), options.data as T);\r\n  }\r\n\r\n  public setDocument<T>(options: SetDocument<T>): Promise<void> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    return setDoc(doc(this.firestore, options.reference), options.data as T, {\r\n      merge: options.merge\r\n    });\r\n  }\r\n\r\n  public deleteDocument(options: DocumnentQuery): Promise<void> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    return deleteDoc(doc(this.firestore, options.reference));\r\n  }\r\n\r\n  public addDocument<T>(options: AddDocument<T>): Promise<DocumentReference> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    return addDoc(collection(this.firestore, options.reference), options.data as T).then(docRef => {\r\n      return {\r\n        id: docRef.id,\r\n        path: docRef.path\r\n      }\r\n    });\r\n  }\r\n\r\n  public addCollectionSnapshotListener<T>(options: CollectionQuery, callback: CollectionSnapshotCallback<T>): Promise<CallbackId> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    let collectionQuery: Query;\r\n    if (options.queryConstraints) {\r\n      const constraints = options.queryConstraints.map(constraint => where(constraint.fieldPath, constraint.opStr, constraint.value));\r\n      collectionQuery = query(collection(this.firestore, options.reference), ...constraints);\r\n    } else {\r\n      collectionQuery = query(collection(this.firestore, options.reference));\r\n    }\r\n\r\n    const unSubFunc = onSnapshot(collectionQuery, snapshot => {\r\n      callback({\r\n        collection: snapshot.docs.map(doc => {\r\n          return {\r\n            id: doc.id,\r\n            path: doc.ref.path,\r\n            data: doc.data() as T\r\n          };\r\n        })\r\n      });\r\n    });\r\n\r\n    const id = new Date().getTime().toString();\r\n    this.subscriptions[id] = unSubFunc;\r\n\r\n    return Promise.resolve(id);\r\n  }\r\n\r\n  public getCollection<T>(options: CollectionQuery): Promise<CollectionSnapshot<T>> {\r\n    if (this.firestore === null) {\r\n      return Promise.reject(\"Firestore not initialized\");\r\n    }\r\n\r\n    let collectionQuery: Query;\r\n    if (options.queryConstraints) {\r\n      const constraints = options.queryConstraints.map(constraint => where(constraint.fieldPath, constraint.opStr, constraint.value));\r\n      collectionQuery = query(collection(this.firestore, options.reference), ...constraints);\r\n    } else {\r\n      collectionQuery = query(collection(this.firestore, options.reference));\r\n    }\r\n\r\n    return getDocs(collectionQuery).then(snapshot => {\r\n      return {\r\n        collection: snapshot.docs.map(doc => {\r\n          return {\r\n            id: doc.id,\r\n            path: doc.ref.path,\r\n            data: doc.data() as T\r\n          };\r\n        })\r\n      };\r\n    });\r\n  }\r\n\r\n  public removeSnapshotListener(options: RemoveSnapshotListener): Promise<void> {\r\n    const unSubFunc = this.subscriptions[options.callbackId];\r\n\r\n    if (unSubFunc === undefined) {\r\n      return Promise.reject(\"No callback with id \" + options.callbackId);\r\n    }\r\n\r\n    unSubFunc();\r\n    delete this.subscriptions[options.callbackId];\r\n\r\n    return Promise.resolve();\r\n  }\r\n\r\n  public signInWithCustomToken(options: CustomToken): Promise<void> {\r\n    if (this.app === null) {\r\n      return Promise.reject(\"app not initialized\");\r\n    }\r\n\r\n    const auth = getAuth(this.app);\r\n    return signInWithCustomToken(auth, options.token).then();\r\n  }\r\n}\r\n"]}